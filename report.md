经过3个星期的艰苦奋斗和无数个夜晚直不起腰的共同熬夜，我和张同学的《仓鼠摆一摆》终于发布了。但还是很多遗憾，比如没做滑动排行榜，没做最高分显示，没做背景切换，但我们的确在给定时间范围内肝到了尽力。也有开心的事，比如我女友和室友实习期间都沉迷这款小游戏让我很有成就感！

来简单谈谈我为什么喜欢这个作品和为什么它做起来很有成就感。

首先，是它的创意。三个星期前，我和张同学一下课就在五道口醉面的餐桌上疯狂讨论，其上餐的低下效率为我们充分探讨游戏模型提供了很好的土壤。我首先提出了要做一个蜘蛛侠的模型（因为刚看完《英雄远征》）。原来是力学专家土木大佬的张同学仔细想想觉得这个游戏比较没有意思，因为根据单摆的模型你荡的没有原来高，就不会上升，越来越低。这时候我们想着要不要加个楼顶的模型，用来做跑酷，这样可以通过跳跃的动量来做到上升的效果，仔细想想，那楼房不也越来越低吗？然后我们又想到了Flappy bird的躲避模型，又觉得难度太高。最后想到了超级马里奥，那就先做一个收集模型吧！

张同学效率比较高，我还在做基础实验4写后端服务的时候，张同学三下五除二搞定了游戏的物理模型，也就是主角荡着绳子黏在顶端，飞来飞去，包含了绳子的伸长，主角的运动。我俩有个共同好友，灵魂男低音兼全能大佬，外号“原妈”，彼时我们已经决定将主角改成一个吐舌头的青蛙（原妈的微信头像)，于是遂随意起名ym（原妈的缩写）,tongue（原定的蛛丝）。

我看了甚为欣喜也甚为忧虑，那我做啥啊？

张同学幽幽说道：我有个问题解决不了，摄像头一直晃动，而且天花板不够长，主角很快就超出视野范围了。

懵逼的我说，好，那我做这个了。于是，我掉入了天坑。张同学把摄像头放在了主角的节点下面，一开始我觉得是坐标系转换的问题，疯狂查阅API，什么`convertToNodeSpaceAR`的，用了一大堆，乱整了一堆函数组合起来，最后结果是：没那么抖了。我跟他暂时接受了这个结果，毕竟现在还只是个黑色背景，一个图片伸出一个长方形晃悠的模型，抖不抖好像不是很重要。

然后我开始解决第二个问题，天花板不够长，我们最后发现，结局问题的方法是，把天花板的尺寸设成0，对，长0宽0，就不用解决这个问题了。

这时候我想，既然张同学把基础逻辑都整了，那我就来修饰呗，首先我就给它加了个背景，很快发现问题了，我们的小青蛙跑一会就To darkness and beyond，坠入无限黑暗了。于是我开始寻找无限背景的解决方案，找啊找啊，找到我快怀疑人生了：全是说主角不动背景后退的，不动个球球！我们主角的基本运动逻辑已经写了俩脚本了，我是不敢动的，只能整背景的坐标变换，整来整去不仅经常出现黑色空缺，还发现有了背景摄像机抖得更厉害了，我哭了。

两晚上没弄出几行代码，头发快掉完了。这时候我做出了大胆的决定，动我们的scene，当时对Cocos Creator很不熟悉的我摸索着把摄像机移到了Canvas节点下，就这样，问题迎刃而解，没有复杂的坐标变换，没有抖动，背景跟着摄像机动就行。虽然就那么几行代码和文件结构的改变，但我深深意识到fix这种行为虽然代码量可能不多，但是损肝还是厉害的。

无限背景然而还是木的办法，我搜了搜资料，没发现适合于Cocos的，但是偶然发现一个背景切换的答案非常有创意，放两张贴图，一张在视野之外，然后等主角和摄像头运动到那里了自然就显示出来了。我立马想到，搞两个一模一样的背景，轮流贴，不久解决问题了，于是有了无限背景。

然而这个主角还是太丑了，我于是沉迷了一天搜索各种素材，最终想到守望先锋里的仓鼠球比较适合，因为是个球，所以动画好做，判定也好做，还挺可爱的，于是我，让张同学调了下抓钩的颜色，加了个小爪子，自己用画图和ppt撸了一个六帧的动画，虽然很耗时间（也不增加代码量），但是怎么说呢，看到一个漂亮的小仓鼠而不是一个白色背景的绿色两栖动物，就俩字，舒坦。

是游戏总得死吧，张同学又效率很高地弄了个简单的判定模型，美其名曰怪物，碰到怪物死了咋办？我参照网上的教程开始做这个死亡结算面板。这过程只能用盲人摸象来形容，首先我得搞清楚控件的属性设置，脚本绑定，然后我得弄清楚游戏结束到底怎么开始，控件是否会被销毁，如何停止动画、事件响应，如果设置可见不可见，总之让这个程序跑起来又成了横亘在面前的难题。

我召唤来了张同学，我俩开始熬夜解决问题，为什么会出现`cannot set property of undefined`这个问题几百次？我俩不知道，这行红字以后还要折磨我们千百回。查了一晚上一白天也没查出来什么头绪，我决定通过加判定和重构代码（原来在子级脚本的现在放在父级脚本里）很丑陋地掩盖了这个问题，让游戏可以重启了。直到这时游戏还是单场景的，这也为后面更加灾难性的结构问题埋下了伏笔。不过在这个过程中，张同学摸清楚了消息发送和处理的机制，这也大大提高了我们的效率。

我们当时痛苦的点是，this指针怎么会是一个undefined呢？这怎么可能呢？刚还log了this呢，这好好的`[object object]`啊，咋回事啊？后来过了很久我才明白，回调函数中this指针没了，它没了，没了……因此应该先用一个self保存一下this指针，再用回调函数。我第一次看到别人代码里的self还以为梦回python，真没想到是这个原因。当时我们的想法局限在异步执行、计时器、对象销毁等复杂情境中无法自拔，也算是一个小坎坷。

勉强解决了这个问题，我们迈入了新阶段，挺顺利的，张同学撸了计分和碰撞事件，加了景深云，通过分层解决了死亡时遮盖面板的bug，我则做了无数个雪碧图和精灵动画，写了很多action，完成了大部分特效，然后加了一个新的开始场景，做了不少跳转的按钮。这时候我们的小作品基本成型了，我也发布到自己的服务器上给我朋友玩了玩，反馈是：挺不错的。

那就开始润色了，我提出吃蘑菇无敌，于是做了吃蘑菇的判定和特效；然后我又说可以模仿涂鸦跳跃踩头杀怪的有趣设定，张同学很快就搞定并且加了音效，在我做完文字提示并上传的那一刻，我觉得我俩要完成一切了，结果另一个差点毁了我们游戏的bug又出现了，又是同样的红字。最后才发现是计时器没有停止计时导致的bug，好在一场虚惊，游戏平稳运行。

张同学由于一开始做了很多工作，特别是实现了最初的demo，所以我劝他好好休息，给我留点活干，于是差遣他写文档去了，哈哈。我在想还能加什么，什么动态移动的怪物增加难度，新手教学我都给加上了，顺带修了几个小bug，甚至连得分自动下沉进入结算面板这种强迫症行为我都做了，但还是觉得代码量比张同学还是少点（主要沉迷美工的时间压缩了自己的代码时长）。这时候我想，欸，写个排行榜应该就差不多了吧，不大不小一个功能，弥补一下，挺好。

正好助教延长了时间，我在走之前跟张同学又熬夜顶着分包的bug弄好了微信平台的发布（张同学天才地提出建立一个preload的scene）。回家之后，开始一个人肝排行榜，花了整整四天，还顶着备课给小朋友带家教的压力，所以依旧熬夜~坑太多，首先用的是Cocos号称好用的新版微信开放数据域控件，网上查的资料又全是老版本的，看起来很复杂，所以我只能抱着很少的文档跟着Cocos官方样例做排行榜，结果又出现了之前经常出现的红字，但是这次红字的主体是一个咱根本不认识的句柄，还是cocos-2d引擎调用的（当时还是没意识到是this指针出了问题）。调不好bug，开始东问西问，赵乙宁同学给了我很大的帮助，然而还是没有解救我。

这时候，黄翔同学之前与我在机场的偶遇启发了我，我急忙询问他他是怎么使用这个控件的，他说自己使用的是老版本，也就是用微信的api接口，用sharedCanvas用代码撸出来的排行榜。当初嫌弃这个方法太麻烦的我索性横下心，试试就试试。于是我删除了所有文件，新建一个index.js，从`wx.onMessage`开始写起，用`fillText`等接口画图、写字，经过艰难尝试，我才成功地实现了数据存储。

然而还是画不出来，花了很久的时间，排雷了代码错误、获取的控件错误、creator背景色设置错误之后，我终于显示出了粗陋的排行榜，然后又是解决重绘问题，覆盖问题，花了大力气调整样式、位置解决美观的问题，我做出了还能看的单页排行榜。

由于实在是对`touchmove`一窍不通，网上大段的文档也看不进去，我干脆放弃了滑动单页排行榜，开始做多页排行榜，然而微信开放数据域的单向传输的限制让我的编程体验极差，最后只能用变量存储和一些数学上的处理实现了一个翻页机制，不过看到最终漂亮的排行榜还是很爽的。

最后一天，整了个小功能，码字，修改代码结构，注释，提交设计文件，直到写完这篇日志。心里什么东西终于落地了，赶上和女票的一周年纪念日，感觉工程就像感情一样，都需要修修补补，赶工返工才能做出外人看似完美的作品吧！

最后附上截图

![ranklist](img\ranklist.jpg)

![tutorial](img\tutorial.jpg)